/*
* NeuQuant Neural-Net Quantization Algorithm
* ------------------------------------------
* 
* Copyright (c) 1994 Anthony Dekker
* 
* NEUQUANT Neural-Net quantization algorithm by Anthony Dekker, 1994. See
* "Kohonen neural networks for optimal colour quantization" in "Network:
* Computation in Neural Systems" Vol. 5 (1994) pp 351-367. for a discussion of
* the algorithm.
* 
* Any party obtaining a copy of these files from the author, directly or
* indirectly, is granted, free of charge, a full and unrestricted irrevocable,
* world-wide, paid up, royalty-free, nonexclusive right and license to deal in
* this software and documentation files (the "Software"), including without
* limitation the rights to use, copy, modify, merge, publish, distribute,
* sublicense, and/or sell copies of the Software, and to permit persons who
* receive copies from any such party to do so, with the only requirement being
* that this copyright notice remain intact.
*/

NeuQuant=function(){var r,n,f,o,t,a={},u=256,c=499,i=491,v=487,e=503,y=3*e,p=u-1,s=4,h=100,A=16,m=1<<A,N=10,Q=10,g=m>>Q,l=m<<N-Q,b=u>>3,d=6,j=1<<d,k=b*j,q=30,w=10,x=1<<w,z=8,B=1<<z,C=w+z,D=1<<C,E=[],F=[],G=[],H=[],I=a.NeuQuant=function I(r,a,c){var i,v
for(n=r,f=a,o=c,t=Array(u),i=0;u>i;i++)t[i]=Array(4),v=t[i],v[0]=v[1]=v[2]=(i<<s+8)/u,G[i]=m/u,F[i]=0},J=function J(){for(var r=[],n=Array(u),f=0;u>f;f++)n[t[f][3]]=f
for(var o=0,a=0;u>a;a++){var c=n[a]
r[o++]=t[c][0],r[o++]=t[c][1],r[o++]=t[c][2]}return r},K=function K(){var r,n,f,o,a,c,i,v
for(i=0,v=0,r=0;u>r;r++){for(a=t[r],f=r,o=a[1],n=r+1;u>n;n++)c=t[n],o>c[1]&&(f=n,o=c[1])
if(c=t[f],r!=f&&(n=c[0],c[0]=a[0],a[0]=n,n=c[1],c[1]=a[1],a[1]=n,n=c[2],c[2]=a[2],a[2]=n,n=c[3],c[3]=a[3],a[3]=n),o!=i){for(E[i]=v+r>>1,n=i+1;o>n;n++)E[n]=r
i=o,v=r}}for(E[i]=v+p>>1,n=i+1;256>n;n++)E[n]=p},L=function L(){var t,a,u,p,A,m,N,Q,g,l,b,j,w,z
for(y>f&&(o=1),r=30+(o-1)/3,j=n,w=0,z=f,b=f/(3*o),l=b/h,Q=x,m=k,N=m>>d,1>=N&&(N=0),t=0;N>t;t++)H[t]=Q*((N*N-t*t)*B/(N*N))
for(g=y>f?3:0!=f%c?3*c:0!=f%i?3*i:0!=f%v?3*v:3*e,t=0;b>t;)if(u=(255&j[w+0])<<s,p=(255&j[w+1])<<s,A=(255&j[w+2])<<s,a=R(u,p,A),P(Q,a,u,p,A),0!=N&&O(N,a,u,p,A),w+=g,w>=z&&(w-=f),t++,0==l&&(l=1),0==t%l)for(Q-=Q/r,m-=m/q,N=m>>d,1>=N&&(N=0),a=0;N>a;a++)H[a]=Q*((N*N-a*a)*B/(N*N))}
a.map=function(r,n,f){var o,a,c,i,v,e,y
for(v=1e3,y=-1,o=E[n],a=o-1;u>o||a>=0;)u>o&&(e=t[o],c=e[1]-n,c>=v?o=u:(o++,0>c&&(c=-c),i=e[0]-r,0>i&&(i=-i),c+=i,v>c&&(i=e[2]-f,0>i&&(i=-i),c+=i,v>c&&(v=c,y=e[3])))),a>=0&&(e=t[a],c=n-e[1],c>=v?a=-1:(a--,0>c&&(c=-c),i=e[0]-r,0>i&&(i=-i),c+=i,v>c&&(i=e[2]-f,0>i&&(i=-i),c+=i,v>c&&(v=c,y=e[3]))))
return y},a.process=function(){return L(),M(),K(),J()}
var M=function M(){var r
for(r=0;u>r;r++)t[r][0]>>=s,t[r][1]>>=s,t[r][2]>>=s,t[r][3]=r},O=function O(r,n,f,o,a){var c,i,v,e,y,p,s
for(v=n-r,-1>v&&(v=-1),e=n+r,e>u&&(e=u),c=n+1,i=n-1,p=1;e>c||i>v;){if(y=H[p++],e>c){s=t[c++]
try{s[0]-=y*(s[0]-f)/D,s[1]-=y*(s[1]-o)/D,s[2]-=y*(s[2]-a)/D}catch(h){}}if(i>v){s=t[i--]
try{s[0]-=y*(s[0]-f)/D,s[1]-=y*(s[1]-o)/D,s[2]-=y*(s[2]-a)/D}catch(h){}}}},P=function P(r,n,f,o,a){var u=t[n]
u[0]-=r*(u[0]-f)/x,u[1]-=r*(u[1]-o)/x,u[2]-=r*(u[2]-a)/x},R=function R(r,n,f){var o,a,c,i,v,e,y,p,h,m
for(p=~(1<<31),h=p,e=-1,y=e,o=0;u>o;o++)m=t[o],a=m[0]-r,0>a&&(a=-a),c=m[1]-n,0>c&&(c=-c),a+=c,c=m[2]-f,0>c&&(c=-c),a+=c,p>a&&(p=a,e=o),i=a-(F[o]>>A-s),h>i&&(h=i,y=o),v=G[o]>>Q,G[o]-=v,F[o]+=v<<N
return G[e]+=g,F[e]-=l,y}
return I.apply(this,arguments),a}

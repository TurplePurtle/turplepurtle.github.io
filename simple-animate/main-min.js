/**
* This class handles LZW encoding
* Adapted from Jef Poskanzer's Java port by way of J. M. G. Elliott.
* @author Kevin Weiner (original Java version - kweiner@fmsware.com)
* @author Thibault Imbert (AS3 version - bytearray.org)
* @version 0.1 AS3 implementation
*/
LZWEncoder=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h={},p=-1,d=12,v=5003,m=d,g=1<<d,y=[],b=[],w=v,E=0,S=!1,x=0,T=0,N=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],C=[],k=h.LZWEncoder=function(s,o,u,a){e=s,t=o,n=u,r=Math.max(2,a)},L=function(t,n){C[c++]=t,c>=254&&_(n)},A=function(t){O(w),E=f+2,S=!0,H(f,t)},O=function(t){for(var n=0;t>n;++n)y[n]=-1},M=h.compress=function(t,n){var r,i,s,h,d,v,x;for(a=t,S=!1,o=a,u=D(o),f=1<<t-1,l=f+1,E=f+2,c=0,h=P(),x=0,r=w;65536>r;r*=2)++x;x=8-x,v=w,O(v),H(f,n);e:for(;(s=P())!=p;)if(r=(s<<m)+h,i=s<<x^h,y[i]!=r){if(y[i]>=0){d=v-i,0==i&&(d=1);do if(0>(i-=d)&&(i+=v),y[i]==r){h=b[i];continue e}while(y[i]>=0)}H(h,n),h=s,g>E?(b[i]=E++,y[i]=r):A(n)}else h=b[i];H(h,n),H(l,n)};h.encode=function(n){n.writeByte(r),i=e*t,s=0,M(r+1,n),n.writeByte(0)};var _=function(t){c>0&&(t.writeByte(c),t.writeBytes(C,0,c),c=0)},D=function(t){return(1<<t)-1},P=function(){if(0==i)return p;--i;var t=n[s++];return 255&t},H=function(t,n){for(x&=N[T],T>0?x|=t<<T:x=t,T+=o;T>=8;)L(255&x,n),x>>=8,T-=8;if((E>u||S)&&(S?(u=D(o=a),S=!1):(++o,u=o==m?g:D(o))),t==l){for(;T>0;)L(255&x,n),x>>=8,T-=8;_(n)}};return k.apply(this,arguments),h};
/*
* NeuQuant Neural-Net Quantization Algorithm
* ------------------------------------------
* 
* Copyright (c) 1994 Anthony Dekker
* 
* NEUQUANT Neural-Net quantization algorithm by Anthony Dekker, 1994. See
* "Kohonen neural networks for optimal colour quantization" in "Network:
* Computation in Neural Systems" Vol. 5 (1994) pp 351-367. for a discussion of
* the algorithm.
* 
* Any party obtaining a copy of these files from the author, directly or
* indirectly, is granted, free of charge, a full and unrestricted irrevocable,
* world-wide, paid up, royalty-free, nonexclusive right and license to deal in
* this software and documentation files (the "Software"), including without
* limitation the rights to use, copy, modify, merge, publish, distribute,
* sublicense, and/or sell copies of the Software, and to permit persons who
* receive copies from any such party to do so, with the only requirement being
* that this copyright notice remain intact.
*/
NeuQuant=function(){var e,t,n,r,i,s={},o=256,u=499,a=491,f=487,l=503,c=3*l,h=o-1,p=4,d=100,v=16,m=1<<v,g=10,y=10,b=m>>y,w=m<<g-y,E=o>>3,S=6,x=1<<S,T=E*x,N=30,C=10,k=1<<C,L=8,A=1<<L,O=C+L,M=1<<O,_=[],D=[],P=[],H=[],B=s.NeuQuant=function(s,u,a){var f,l;for(t=s,n=u,r=a,i=Array(o),f=0;o>f;f++)i[f]=Array(4),l=i[f],l[0]=l[1]=l[2]=(f<<p+8)/o,P[f]=m/o,D[f]=0},j=function(){for(var t=[],n=Array(o),r=0;o>r;r++)n[i[r][3]]=r;for(var s=0,u=0;o>u;u++){var a=n[u];t[s++]=i[a][0],t[s++]=i[a][1],t[s++]=i[a][2]}return t},F=function(){var t,n,r,s,u,a,f,l;for(f=0,l=0,t=0;o>t;t++){for(u=i[t],r=t,s=u[1],n=t+1;o>n;n++)a=i[n],s>a[1]&&(r=n,s=a[1]);if(a=i[r],t!=r&&(n=a[0],a[0]=u[0],u[0]=n,n=a[1],a[1]=u[1],u[1]=n,n=a[2],a[2]=u[2],u[2]=n,n=a[3],a[3]=u[3],u[3]=n),s!=f){for(_[f]=l+t>>1,n=f+1;s>n;n++)_[n]=t;f=s,l=t}}for(_[f]=l+h>>1,n=f+1;256>n;n++)_[n]=h},I=function(){var s,o,h,v,m,g,y,b,w,E,x,C,L,O;for(c>n&&(r=1),e=30+(r-1)/3,C=t,L=0,O=n,x=n/(3*r),E=x/d,b=k,g=T,y=g>>S,1>=y&&(y=0),s=0;y>s;s++)H[s]=b*((y*y-s*s)*A/(y*y));for(w=c>n?3:0!=n%u?3*u:0!=n%a?3*a:0!=n%f?3*f:3*l,s=0;x>s;)if(h=(255&C[L+0])<<p,v=(255&C[L+1])<<p,m=(255&C[L+2])<<p,o=z(h,v,m),U(b,o,h,v,m),0!=y&&R(y,o,h,v,m),L+=w,L>=O&&(L-=n),s++,0==E&&(E=1),0==s%E)for(b-=b/e,g-=g/N,y=g>>S,1>=y&&(y=0),o=0;y>o;o++)H[o]=b*((y*y-o*o)*A/(y*y))};s.map=function(e,t,n){var r,s,u,a,f,l,c;for(f=1e3,c=-1,r=_[t],s=r-1;o>r||s>=0;)o>r&&(l=i[r],u=l[1]-t,u>=f?r=o:(r++,0>u&&(u=-u),a=l[0]-e,0>a&&(a=-a),u+=a,f>u&&(a=l[2]-n,0>a&&(a=-a),u+=a,f>u&&(f=u,c=l[3])))),s>=0&&(l=i[s],u=t-l[1],u>=f?s=-1:(s--,0>u&&(u=-u),a=l[0]-e,0>a&&(a=-a),u+=a,f>u&&(a=l[2]-n,0>a&&(a=-a),u+=a,f>u&&(f=u,c=l[3]))));return c},s.process=function(){return I(),q(),F(),j()};var q=function(){var t;for(t=0;o>t;t++)i[t][0]>>=p,i[t][1]>>=p,i[t][2]>>=p,i[t][3]=t},R=function(t,n,r,s,u){var a,f,l,c,h,p,d;for(l=n-t,-1>l&&(l=-1),c=n+t,c>o&&(c=o),a=n+1,f=n-1,p=1;c>a||f>l;){if(h=H[p++],c>a){d=i[a++];try{d[0]-=h*(d[0]-r)/M,d[1]-=h*(d[1]-s)/M,d[2]-=h*(d[2]-u)/M}catch(v){}}if(f>l){d=i[f--];try{d[0]-=h*(d[0]-r)/M,d[1]-=h*(d[1]-s)/M,d[2]-=h*(d[2]-u)/M}catch(v){}}}},U=function(t,n,r,s,o){var u=i[n];u[0]-=t*(u[0]-r)/k,u[1]-=t*(u[1]-s)/k,u[2]-=t*(u[2]-o)/k},z=function(t,n,r){var s,u,a,f,l,c,h,d,m,E;for(d=2147483647,m=d,c=-1,h=c,s=0;o>s;s++)E=i[s],u=E[0]-t,0>u&&(u=-u),a=E[1]-n,0>a&&(a=-a),u+=a,a=E[2]-r,0>a&&(a=-a),u+=a,d>u&&(d=u,c=s),f=u-(D[s]>>v-p),m>f&&(m=f,h=s),l=P[s]>>y,P[s]-=l,D[s]+=l<<g;return P[c]+=b,D[c]-=w,h};return B.apply(this,arguments),s};
/**
* This class lets you encode animated GIF files
* Base class :  http://www.java2s.com/Code/Java/2D-Graphics-GUI/AnimatedGifEncoder.htm
* @author Kevin Weiner (original Java version - kweiner@fmsware.com)
* @author Thibault Imbert (AS3 version - bytearray.org)
* @version 0.1 AS3 implementation
*/
GIFEncoder=function(){function e(){this.bin=[]}for(var t=0,n={};256>t;t++)n[t]=String.fromCharCode(t);e.prototype.getData=function(){for(var e="",t=this.bin.length,r=0;t>r;r++)e+=n[this.bin[r]];return e},e.prototype.writeByte=function(e){this.bin.push(e)},e.prototype.writeUTFBytes=function(e){for(var t=e.length,n=0;t>n;n++)this.writeByte(e.charCodeAt(n))},e.prototype.writeBytes=function(e,t,n){for(var r=n||e.length,i=t||0;r>i;i++)this.writeByte(e[i])};var r,i,s,o,u,a,f,l,c,h={},p=null,d=-1,v=0,m=!1,g=[],y=7,b=-1,w=!1,E=!0,S=!1,x=10;h.setDelay=function(e){v=Math.round(e/10)},h.setDispose=function(e){e>=0&&(b=e)},h.setRepeat=function(e){e>=0&&(d=e)},h.setTransparent=function(e){p=e},h.addFrame=function(e,t){if(null==e||!m||null==o)throw Error("Please call start method before calling addFrame");var n=!0;try{t?u=e:(u=e.getImageData(0,0,e.canvas.width,e.canvas.height).data,S||N(e.canvas.width,e.canvas.height)),L(),C(),E&&(M(),D(),d>=0&&_()),A(),O(),E||D(),H(),E=!1}catch(r){n=!1}return n},h.finish=function(){if(!m)return!1;var e=!0;m=!1;try{o.writeByte(59)}catch(t){e=!1}return e};var T=function(){s=0,u=null,a=null,f=null,c=null,w=!1,E=!0};h.setFrameRate=function(e){15!=e&&(v=Math.round(100/e))},h.setQuality=function(e){1>e&&(e=1),x=e};var N=h.setSize=function(t,n){(!m||E)&&(r=t,i=n,1>r&&(r=320),1>i&&(i=240),S=!0)};h.start=function(){T();var t=!0;w=!1,o=new e;try{o.writeUTFBytes("GIF89a")}catch(n){t=!1}return m=t},h.cont=function(){T();var t=!0;return w=!1,o=new e,m=t};var C=function(){var t=a.length,n=t/3;f=[];var r=new NeuQuant(a,t,x);c=r.process();for(var i=0,o=0;n>o;o++){var u=r.map(255&a[i++],255&a[i++],255&a[i++]);g[u]=!0,f[o]=u}a=null,l=8,y=7,null!=p&&(s=k(p))},k=function(t){if(null==c)return-1;for(var n=(16711680&t)>>16,r=(65280&t)>>8,i=255&t,s=0,o=16777216,u=c.length,a=0;u>a;){var f=n-(255&c[a++]),l=r-(255&c[a++]),h=i-(255&c[a]),p=f*f+l*l+h*h,d=a/3;g[d]&&o>p&&(o=p,s=d),a++}return s},L=function(){var t=r,n=i;a=[];for(var s=u,o=0,f=0;n>f;f++)for(var l=0;t>l;l++){var c=4*f*t+4*l;a[o++]=s[c],a[o++]=s[c+1],a[o++]=s[c+2]}},A=function(){o.writeByte(33),o.writeByte(249),o.writeByte(4);var t,n;null==p?(t=0,n=0):(t=1,n=2),b>=0&&(n=7&b),n<<=2,o.writeByte(0|(0|n)|t),P(v),o.writeByte(s),o.writeByte(0)},O=function(){o.writeByte(44),P(0),P(0),P(r),P(i),E?o.writeByte(0):o.writeByte(128|y)},M=function(){P(r),P(i),o.writeByte(240|y),o.writeByte(0),o.writeByte(0)},_=function(){o.writeByte(33),o.writeByte(255),o.writeByte(11),o.writeUTFBytes("NETSCAPE2.0"),o.writeByte(3),o.writeByte(1),P(d),o.writeByte(0)},D=function(){o.writeBytes(c);for(var t=768-c.length,n=0;t>n;n++)o.writeByte(0)},P=function(t){o.writeByte(255&t),o.writeByte(255&t>>8)},H=function(){var t=new LZWEncoder(r,i,f,l);t.encode(o)};return h.stream=function(){return o},h.setProperties=function(e,t){m=e,E=t},h};
/**
 * jscolor, JavaScript Color Picker
 *
 * @version 1.4.0
 * @license GNU Lesser General Public License, http://www.gnu.org/copyleft/lesser.html
 * @author  Jan Odvarko, http://odvarko.cz
 * @created 2008-06-15
 * @updated 2012-07-06
 * @link    http://jscolor.com
 */
var jscolor={dir:"",bindClass:"color",binding:!1,preloading:!0,install:function(){jscolor.addEvent(window,"load",jscolor.init)},init:function(){jscolor.binding&&jscolor.bind(),jscolor.preloading&&jscolor.preload()},getDir:function(){if(!jscolor.dir){var e=jscolor.detectDir();jscolor.dir=e!==!1?e:"jscolor/"}return jscolor.dir},detectDir:function(){for(var e=location.href,t=document.getElementsByTagName("base"),n=0;t.length>n;n+=1)t[n].href&&(e=t[n].href);for(var t=document.getElementsByTagName("script"),n=0;t.length>n;n+=1)if(t[n].src&&/(^|\/)jscolor\.js([?#].*)?$/i.test(t[n].src)){var r=new jscolor.URI(t[n].src),i=r.toAbsolute(e);return i.path=i.path.replace(/[^\/]+$/,""),i.query=null,i.fragment=null,""+i}return!1},bind:function(){for(var e=document.querySelectorAll("input.color"),t=0;e.length>t;t+=1)e[t].color||(e[t].color=new jscolor.color(e[t],{}))},preload:function(){for(var e in jscolor.imgRequire)jscolor.imgRequire.hasOwnProperty(e)&&jscolor.loadImage(e)},images:{pad:[181,101],sld:[16,101],cross:[15,15],arrow:[7,11]},imgRequire:{},imgLoaded:{},requireImage:function(e){jscolor.imgRequire[e]=!0},loadImage:function(e){jscolor.imgLoaded[e]||(jscolor.imgLoaded[e]=new Image,jscolor.imgLoaded[e].src=jscolor.getDir()+e)},fetchElement:function(e){return"string"==typeof e?document.getElementById(e):e},addEvent:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},fireEvent:function(e,t){if(e)if(document.createEvent){var n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!0),e.dispatchEvent(n)}else if(document.createEventObject){var n=document.createEventObject();e.fireEvent("on"+t,n)}else e["on"+t]&&e["on"+t]()},getElementPos:function(e){var t=e,n=e,r=0,i=0;if(t.offsetParent)do r+=t.offsetLeft,i+=t.offsetTop;while(t=t.offsetParent);for(;(n=n.parentNode)&&"BODY"!==n.nodeName.toUpperCase();)r-=n.scrollLeft,i-=n.scrollTop;return[r,i]},getElementSize:function(e){return[e.offsetWidth,e.offsetHeight]},getRelMousePos:function(e){var t=0,n=0;return e||(e=window.event),"number"==typeof e.offsetX?(t=e.offsetX,n=e.offsetY):"number"==typeof e.layerX&&(t=e.layerX,n=e.layerY),{x:t,y:n}},getViewPos:function(){return"number"==typeof window.pageYOffset?[window.pageXOffset,window.pageYOffset]:document.body&&(document.body.scrollLeft||document.body.scrollTop)?[document.body.scrollLeft,document.body.scrollTop]:document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)?[document.documentElement.scrollLeft,document.documentElement.scrollTop]:[0,0]},getViewSize:function(){return"number"==typeof window.innerWidth?[window.innerWidth,window.innerHeight]:document.body&&(document.body.clientWidth||document.body.clientHeight)?[document.body.clientWidth,document.body.clientHeight]:document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?[document.documentElement.clientWidth,document.documentElement.clientHeight]:[0,0]},URI:function(e){function t(e){for(var t="";e;)if("../"===e.substr(0,3)||"./"===e.substr(0,2))e=e.replace(/^\.+/,"").substr(1);else if("/./"===e.substr(0,3)||"/."===e)e="/"+e.substr(3);else if("/../"===e.substr(0,4)||"/.."===e)e="/"+e.substr(4),t=t.replace(/\/?[^\/]*$/,"");else if("."===e||".."===e)e="";else{var n=e.match(/^\/?[^\/]*/)[0];e=e.substr(n.length),t+=n}return t}this.scheme=null,this.authority=null,this.path="",this.query=null,this.fragment=null,this.parse=function(e){var t=e.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);return this.scheme=t[3]?t[2]:null,this.authority=t[5]?t[6]:null,this.path=t[7],this.query=t[9]?t[10]:null,this.fragment=t[12]?t[13]:null,this},this.toString=function(){var e="";return null!==this.scheme&&(e=e+this.scheme+":"),null!==this.authority&&(e=e+"//"+this.authority),null!==this.path&&(e+=this.path),null!==this.query&&(e=e+"?"+this.query),null!==this.fragment&&(e=e+"#"+this.fragment),e},this.toAbsolute=function(e){var e=new jscolor.URI(e),n=this,r=new jscolor.URI;return null===e.scheme?!1:(null!==n.scheme&&n.scheme.toLowerCase()===e.scheme.toLowerCase()&&(n.scheme=null),null!==n.scheme?(r.scheme=n.scheme,r.authority=n.authority,r.path=t(n.path),r.query=n.query):(null!==n.authority?(r.authority=n.authority,r.path=t(n.path),r.query=n.query):(""===n.path?(r.path=e.path,r.query=null!==n.query?n.query:e.query):("/"===n.path.substr(0,1)?r.path=t(n.path):(r.path=null!==e.authority&&""===e.path?"/"+n.path:e.path.replace(/[^\/]+$/,"")+n.path,r.path=t(r.path)),r.query=n.query),r.authority=e.authority),r.scheme=e.scheme),r.fragment=n.fragment,r)},e&&this.parse(e)},color:function(e,t){function n(e,t,n){var r=Math.min(Math.min(e,t),n),i=Math.max(Math.max(e,t),n),s=i-r;if(0===s)return[null,0,i];var o=e===r?3+(n-t)/s:t===r?5+(e-n)/s:1+(t-e)/s;return[6===o?0:o,s/i,i]}function r(e,t,n){if(null===e)return[n,n,n];var r=Math.floor(e),i=r%2?e-r:1-(e-r),s=n*(1-t),o=n*(1-t*i);switch(r){case 6:case 0:return[n,o,s];case 1:return[o,n,s];case 2:return[s,n,o];case 3:return[s,o,n];case 4:return[o,s,n];case 5:return[n,s,o]}}function i(){delete jscolor.picker.owner,document.getElementsByTagName("body")[0].removeChild(jscolor.picker.boxB)}function s(t,n){function r(){var e=m.pickerInsetColor.split(/\s+/),t=2>e.length?e[0]:e[1]+" "+e[0]+" "+e[0]+" "+e[1];l.btn.style.borderColor=t}if(!jscolor.picker){jscolor.picker={box:document.createElement("div"),boxB:document.createElement("div"),pad:document.createElement("div"),padB:document.createElement("div"),padM:document.createElement("div"),sld:document.createElement("div"),sldB:document.createElement("div"),sldM:document.createElement("div"),btn:document.createElement("div"),btnS:document.createElement("span"),btnT:document.createTextNode(m.pickerCloseText)};for(var i=0,s=4;jscolor.images.sld[1]>i;i+=s){var f=document.createElement("div");f.style.height=s+"px",f.style.fontSize="1px",f.style.lineHeight="0",jscolor.picker.sld.appendChild(f)}jscolor.picker.sldB.appendChild(jscolor.picker.sld),jscolor.picker.box.appendChild(jscolor.picker.sldB),jscolor.picker.box.appendChild(jscolor.picker.sldM),jscolor.picker.padB.appendChild(jscolor.picker.pad),jscolor.picker.box.appendChild(jscolor.picker.padB),jscolor.picker.box.appendChild(jscolor.picker.padM),jscolor.picker.btnS.appendChild(jscolor.picker.btnT),jscolor.picker.btn.appendChild(jscolor.picker.btnS),jscolor.picker.box.appendChild(jscolor.picker.btn),jscolor.picker.boxB.appendChild(jscolor.picker.box)}var l=jscolor.picker;l.box.onmouseup=l.box.onmouseout=function(){e.focus()},l.box.onmousedown=function(){y=!0},l.box.onmousemove=function(e){(E||S)&&(E&&h(e),S&&p(e),document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),d())},l.padM.onmouseup=l.padM.onmouseout=function(){E&&(E=!1,jscolor.fireEvent(b,"change"))},l.padM.onmousedown=function(e){switch(g){case 0:0===m.hsv[2]&&m.fromHSV(null,null,1);break;case 1:0===m.hsv[1]&&m.fromHSV(null,1,null)}E=!0,h(e),d()},l.sldM.onmouseup=l.sldM.onmouseout=function(){S&&(S=!1,jscolor.fireEvent(b,"change"))},l.sldM.onmousedown=function(e){S=!0,p(e),d()};var c=o(m);l.box.style.width=c[0]+"px",l.box.style.height=c[1]+"px",l.boxB.style.position="absolute",l.boxB.style.clear="both",l.boxB.style.left=t+"px",l.boxB.style.top=n+"px",l.boxB.style.zIndex=m.pickerZIndex,l.boxB.style.border=m.pickerBorder+"px solid",l.boxB.style.borderColor=m.pickerBorderColor,l.boxB.style.background=m.pickerFaceColor,l.pad.style.width=jscolor.images.pad[0]+"px",l.pad.style.height=jscolor.images.pad[1]+"px",l.padB.style.position="absolute",l.padB.style.left=m.pickerFace+"px",l.padB.style.top=m.pickerFace+"px",l.padB.style.border=m.pickerInset+"px solid",l.padB.style.borderColor=m.pickerInsetColor,l.padM.style.position="absolute",l.padM.style.left="0",l.padM.style.top="0",l.padM.style.width=m.pickerFace+2*m.pickerInset+jscolor.images.pad[0]+jscolor.images.arrow[0]+"px",l.padM.style.height=l.box.style.height,l.padM.style.cursor="crosshair",l.sld.style.overflow="hidden",l.sld.style.width=jscolor.images.sld[0]+"px",l.sld.style.height=jscolor.images.sld[1]+"px",l.sldB.style.display=m.slider?"block":"none",l.sldB.style.position="absolute",l.sldB.style.right=m.pickerFace+"px",l.sldB.style.top=m.pickerFace+"px",l.sldB.style.border=m.pickerInset+"px solid",l.sldB.style.borderColor=m.pickerInsetColor,l.sldM.style.display=m.slider?"block":"none",l.sldM.style.position="absolute",l.sldM.style.right="0",l.sldM.style.top="0",l.sldM.style.width=jscolor.images.sld[0]+jscolor.images.arrow[0]+m.pickerFace+2*m.pickerInset+"px",l.sldM.style.height=l.box.style.height;try{l.sldM.style.cursor="pointer"}catch(v){l.sldM.style.cursor="hand"}l.btn.style.display=m.pickerClosable?"block":"none",l.btn.style.position="absolute",l.btn.style.left=m.pickerFace+"px",l.btn.style.bottom=m.pickerFace+"px",l.btn.style.padding="0 15px",l.btn.style.height="18px",l.btn.style.border=m.pickerInset+"px solid",r(),l.btn.style.color=m.pickerButtonColor,l.btn.style.font="12px sans-serif",l.btn.style.textAlign="center";try{l.btn.style.cursor="pointer"}catch(v){l.btn.style.cursor="hand"}switch(l.btn.onmousedown=function(){m.hidePicker()},l.btnS.style.lineHeight=l.btn.style.height,g){case 0:var w="hs.png";break;case 1:var w="hv.png"}l.padM.style.backgroundImage="url('"+jscolor.getDir()+"cross.gif')",l.padM.style.backgroundRepeat="no-repeat",l.sldM.style.backgroundImage="url('"+jscolor.getDir()+"arrow.gif')",l.sldM.style.backgroundRepeat="no-repeat",l.pad.style.backgroundImage="url('"+jscolor.getDir()+w+"')",l.pad.style.backgroundRepeat="no-repeat",l.pad.style.backgroundPosition="0 0",u(),a(),jscolor.picker.owner=m,document.getElementsByTagName("body")[0].appendChild(l.boxB)}function o(e){var t=[2*e.pickerInset+2*e.pickerFace+jscolor.images.pad[0]+(e.slider?2*e.pickerInset+2*jscolor.images.arrow[0]+jscolor.images.sld[0]:0),e.pickerClosable?4*e.pickerInset+3*e.pickerFace+jscolor.images.pad[1]+e.pickerButtonHeight:2*e.pickerInset+2*e.pickerFace+jscolor.images.pad[1]];return t}function u(){switch(g){case 0:var e=1;break;case 1:var e=2}var t=Math.round(m.hsv[0]/6*(jscolor.images.pad[0]-1)),n=Math.round((1-m.hsv[e])*(jscolor.images.pad[1]-1));jscolor.picker.padM.style.backgroundPosition=m.pickerFace+m.pickerInset+t-Math.floor(jscolor.images.cross[0]/2)+"px "+(m.pickerFace+m.pickerInset+n-Math.floor(jscolor.images.cross[1]/2))+"px";var i=jscolor.picker.sld.childNodes;switch(g){case 0:for(var s=r(m.hsv[0],m.hsv[1],1),o=0;i.length>o;o+=1)i[o].style.backgroundColor="rgb("+100*s[0]*(1-o/i.length)+"%,"+100*s[1]*(1-o/i.length)+"%,"+100*s[2]*(1-o/i.length)+"%)";break;case 1:var s,u,a=[m.hsv[2],0,0],o=Math.floor(m.hsv[0]),f=o%2?m.hsv[0]-o:1-(m.hsv[0]-o);switch(o){case 6:case 0:s=[0,1,2];break;case 1:s=[1,0,2];break;case 2:s=[2,0,1];break;case 3:s=[2,1,0];break;case 4:s=[1,2,0];break;case 5:s=[0,2,1]}for(var o=0;i.length>o;o+=1)u=1-1/(i.length-1)*o,a[1]=a[0]*(1-u*f),a[2]=a[0]*(1-u),i[o].style.backgroundColor="rgb("+100*a[s[0]]+"%,"+100*a[s[1]]+"%,"+100*a[s[2]]+"%)"}}function a(){switch(g){case 0:var e=2;break;case 1:var e=1}var t=Math.round((1-m.hsv[e])*(jscolor.images.sld[1]-1));jscolor.picker.sldM.style.backgroundPosition="0 "+(m.pickerFace+m.pickerInset+t-Math.floor(jscolor.images.arrow[1]/2))+"px"}function f(){return jscolor.picker&&jscolor.picker.owner===m}function l(){b===e&&m.importColor(),m.pickerOnfocus&&m.hidePicker()}function c(){b!==e&&m.importColor()}function h(e){var t=jscolor.getRelMousePos(e),n=t.x-m.pickerFace-m.pickerInset,r=t.y-m.pickerFace-m.pickerInset;switch(g){case 0:m.fromHSV(n*(6/(jscolor.images.pad[0]-1)),1-r/(jscolor.images.pad[1]-1),null,C);break;case 1:m.fromHSV(n*(6/(jscolor.images.pad[0]-1)),null,1-r/(jscolor.images.pad[1]-1),C)}}function p(e){var t=jscolor.getRelMousePos(e),n=t.y-m.pickerFace-m.pickerInset;switch(g){case 0:m.fromHSV(null,null,1-n/(jscolor.images.sld[1]-1),N);break;case 1:m.fromHSV(null,1-n/(jscolor.images.sld[1]-1),null,N)}}function d(){if(m.onImmediateChange){var e;e="string"==typeof m.onImmediateChange?Function(m.onImmediateChange):m.onImmediateChange,e.call(m)}}this.required=!0,this.adjust=!0,this.hash=!0,this.caps=!0,this.slider=!0,this.valueElement=e,this.styleElement=e,this.onImmediateChange=null,this.hsv=[0,0,1],this.rgb=[1,1,1],this.minH=0,this.maxH=6,this.minS=0,this.maxS=1,this.minV=0,this.maxV=1,this.pickerOnfocus=!0,this.pickerMode="HSV",this.pickerPosition="bottom",this.pickerSmartPosition=!0,this.pickerButtonHeight=20,this.pickerClosable=!1,this.pickerCloseText="Close",this.pickerButtonColor="ButtonText",this.pickerFace=10,this.pickerFaceColor="ThreeDFace",this.pickerBorder=1,this.pickerBorderColor="ThreeDHighlight ThreeDShadow ThreeDShadow ThreeDHighlight",this.pickerInset=1,this.pickerInsetColor="ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow",this.pickerZIndex=1e4;for(var v in t)t.hasOwnProperty(v)&&(this[v]=t[v]);this.hidePicker=function(){f()&&i()},this.showPicker=function(){if(!f()){var t,n,r,i=jscolor.getElementPos(e),u=jscolor.getElementSize(e),a=jscolor.getViewPos(),l=jscolor.getViewSize(),c=o(this);switch(this.pickerPosition.toLowerCase()){case"left":t=1,n=0,r=-1;break;case"right":t=1,n=0,r=1;break;case"top":t=0,n=1,r=-1;break;default:t=0,n=1,r=1}var h=(u[n]+c[n])/2;if(this.pickerSmartPosition)var p=[-a[t]+i[t]+c[t]>l[t]?-a[t]+i[t]+u[t]/2>l[t]/2&&i[t]+u[t]-c[t]>=0?i[t]+u[t]-c[t]:i[t]:i[t],-a[n]+i[n]+u[n]+c[n]-h+h*r>l[n]?-a[n]+i[n]+u[n]/2>l[n]/2&&i[n]+u[n]-h-h*r>=0?i[n]+u[n]-h-h*r:i[n]+u[n]-h+h*r:i[n]+u[n]-h+h*r>=0?i[n]+u[n]-h+h*r:i[n]+u[n]-h-h*r];else var p=[i[t],i[n]+u[n]-h+h*r];s(p[t],p[n])}},this.importColor=function(){b?this.adjust?!this.required&&/^\s*$/.test(b.value)?(b.value="",w.style.backgroundImage=w.jscStyle.backgroundImage,w.style.backgroundColor=w.jscStyle.backgroundColor,w.style.color=w.jscStyle.color,this.exportColor(x|T)):this.fromString(b.value)||this.exportColor():this.fromString(b.value,x)||(w.style.backgroundImage=w.jscStyle.backgroundImage,w.style.backgroundColor=w.jscStyle.backgroundColor,w.style.color=w.jscStyle.color,this.exportColor(x|T)):this.exportColor()},this.exportColor=function(e){if(!(e&x)&&b){var t=""+this;this.caps&&(t=t.toUpperCase()),this.hash&&(t="#"+t),b.value=t}e&T||!w||(w.style.backgroundImage="none",w.style.backgroundColor="#"+(""+this),w.style.color=.5>.213*this.rgb[0]+.715*this.rgb[1]+.072*this.rgb[2]?"#FFF":"#000"),e&N||!f()||u(),e&C||!f()||a()},this.fromHSV=function(e,t,n,i){null!==e&&(e=Math.max(0,this.minH,Math.min(6,this.maxH,e))),null!==t&&(t=Math.max(0,this.minS,Math.min(1,this.maxS,t))),null!==n&&(n=Math.max(0,this.minV,Math.min(1,this.maxV,n))),this.rgb=r(null===e?this.hsv[0]:this.hsv[0]=e,null===t?this.hsv[1]:this.hsv[1]=t,null===n?this.hsv[2]:this.hsv[2]=n),this.exportColor(i)},this.fromRGB=function(e,t,i,s){null!==e&&(e=Math.max(0,Math.min(1,e))),null!==t&&(t=Math.max(0,Math.min(1,t))),null!==i&&(i=Math.max(0,Math.min(1,i)));var o=n(null===e?this.rgb[0]:e,null===t?this.rgb[1]:t,null===i?this.rgb[2]:i);null!==o[0]&&(this.hsv[0]=Math.max(0,this.minH,Math.min(6,this.maxH,o[0]))),0!==o[2]&&(this.hsv[1]=null===o[1]?null:Math.max(0,this.minS,Math.min(1,this.maxS,o[1]))),this.hsv[2]=null===o[2]?null:Math.max(0,this.minV,Math.min(1,this.maxV,o[2]));var u=r(this.hsv[0],this.hsv[1],this.hsv[2]);this.rgb[0]=u[0],this.rgb[1]=u[1],this.rgb[2]=u[2],this.exportColor(s)},this.fromString=function(e,t){var n=e.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i);return n?(6===n[1].length?this.fromRGB(parseInt(n[1].substr(0,2),16)/255,parseInt(n[1].substr(2,2),16)/255,parseInt(n[1].substr(4,2),16)/255,t):this.fromRGB(parseInt(n[1].charAt(0)+n[1].charAt(0),16)/255,parseInt(n[1].charAt(1)+n[1].charAt(1),16)/255,parseInt(n[1].charAt(2)+n[1].charAt(2),16)/255,t),!0):!1},this.toString=function(){return(256|Math.round(255*this.rgb[0])).toString(16).substr(1)+(256|Math.round(255*this.rgb[1])).toString(16).substr(1)+(256|Math.round(255*this.rgb[2])).toString(16).substr(1)};var m=this,g="hvs"===this.pickerMode.toLowerCase()?1:0,y=!1,b=jscolor.fetchElement(this.valueElement),w=jscolor.fetchElement(this.styleElement),E=!1,S=!1,x=1,T=2,N=4,C=8;if(jscolor.addEvent(e,"focus",function(){m.pickerOnfocus&&m.showPicker()}),jscolor.addEvent(e,"blur",function(){y?y=!1:window.setTimeout(function(){y||l(),y=!1},0)}),b){var k=function(){m.fromString(b.value,x),d()};b.onchange=k,jscolor.addEvent(b,"input",k),jscolor.addEvent(b,"blur",c),b.setAttribute("autocomplete","off")}switch(w&&(w.jscStyle={backgroundImage:w.style.backgroundImage,backgroundColor:w.style.backgroundColor,color:w.style.color}),g){case 0:jscolor.requireImage("hs.png");break;case 1:jscolor.requireImage("hv.png")}jscolor.requireImage("cross.gif"),jscolor.requireImage("arrow.gif"),this.importColor()}};jscolor.install();
/*
html5slider - a JS implementation of <input type=range> for Firefox 16 and up
https://github.com/fryn/html5slider

Copyright (c) 2010-2012 Frank Yan, <http://frankyan.com>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
(function(){function e(){h.call(document.querySelectorAll("input[type=range]"),n),(new MutationObserver(function(e){e.forEach(function(e){e.addedNodes&&h.call(e.addedNodes,function(e){t(e),e.childElementCount&&h.call(e.querySelectorAll("input"),t)})})})).observe(document,{childList:!0,subtree:!0})}function t(e){"input"==e.localName&&"range"!=e.type&&"range"==e.getAttribute("type")&&n(e)}function n(e){function t(e){if(e.touches&&(e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY),x=!0,setTimeout(function(){x=!1},0),!e.button&&O){var t=parseFloat(getComputedStyle(this,0).width),r=(t-a.width)/O;if(r){var s=e.clientX-this.getBoundingClientRect().left-a.width/2-(M-k)*r;Math.abs(s)>a.radius&&(S=!0,this.value-=-s/r),N=M,C=e.clientX,this.addEventListener("mousemove",n,!0),this.addEventListener("touchmove",n,!0),this.addEventListener("mouseup",i,!0),this.addEventListener("touchend",i,!0)}}}function n(e){e.touches&&(e.preventDefault(),e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY);var t=parseFloat(getComputedStyle(this,0).width),n=(t-a.width)/O;n&&(N+=(e.clientX-C)/n,C=e.clientX,S=!0,this.value=N)}function i(){this.removeEventListener("mousemove",n,!0),this.removeEventListener("touchmove",n,!0),this.removeEventListener("mouseup",i,!0),this.removeEventListener("touchend",i,!0)}function s(e){e.keyCode>36&&41>e.keyCode&&(h.call(this),S=!0,this.value=M+(38==e.keyCode||39==e.keyCode?A:-A))}function h(){x||(this.style.boxShadow=u?"inset 0 0 20px rgba(0,127,255,.1), 0 0 1px rgba(0,127,255,.4)":"0 0 0 2px #fb0")}function v(){this.style.boxShadow=""}function m(e){return!isNaN(e)&&+e==parseFloat(e)}function g(){k=m(e.min)?+e.min:0,L=m(e.max)?+e.max:100,k>L&&(L=k>100?k:100),A=m(e.step)&&e.step>0?+e.step:1,O=L-k,b(!0)}function y(){w||E||(M=e.getAttribute("value")),m(M)||(M=(k+L)/2),M=Math.round((M-k)/A)*A+k,k>M?M=k:M>L&&(M=k+~~(O/A)*A)}function b(t){if(y(),S&&M!=T&&e.dispatchEvent(p),S=!1,t||M!=T){T=M;var n=O?100*((M-k)/O):0,i="-moz-element(#__sliderthumb__) "+n+"% no-repeat, ";r(e,{background:i+f})}}var w,E,S,x,T,N,C,k,L,A,O,M=e.value;o||(o=document.body.appendChild(document.createElement("hr")),r(o,{"-moz-appearance":u?"scale-horizontal":"scalethumb-horizontal",display:"block",visibility:"visible",opacity:1,position:"fixed",top:"-999999px"}),document.mozSetImageElement("__sliderthumb__",o));var _=function(){return""+M},D=function P(t){M=""+t,w=!0,b(),delete e.value,e.value=M,e.__defineGetter__("value",_),e.__defineSetter__("value",P)};e.__defineGetter__("value",_),e.__defineSetter__("value",D),e.__defineGetter__("type",function(){return"range"}),["min","max","step"].forEach(function(t){e.hasAttribute(t)&&(E=!0),e.__defineGetter__(t,function(){return this.hasAttribute(t)?this.getAttribute(t):""}),e.__defineSetter__(t,function(e){null===e?this.removeAttribute(t):this.setAttribute(t,e)})}),e.readOnly=!0,r(e,l),g(),(new MutationObserver(function(t){t.forEach(function(t){"value"!=t.attributeName?(g(),E=!0):w||(M=e.getAttribute("value"),b())})})).observe(e,c),e.addEventListener("mousedown",t,!0),e.addEventListener("touchstart",t,!0),e.addEventListener("keydown",s,!0),e.addEventListener("focus",h,!0),e.addEventListener("blur",v,!0)}function r(e,t){for(var n in t)e.style.setProperty(n,t[n],"important")}var i=document.createElement("input");try{if(i.type="range","range"==i.type)return}catch(s){return}if(i.style.background="linear-gradient(red, red)",i.style.backgroundImage&&"MozAppearance"in i.style&&document.mozSetImageElement&&this.MutationObserver){var o,u="MacIntel"==navigator.platform,a={radius:u?9:6,width:u?22:12,height:u?16:20},f="linear-gradient(transparent "+(u?"6px, #999 6px, #999 7px, #ccc 8px, #bbb 9px, #bbb 10px, transparent 10px":"9px, #999 9px, #bbb 10px, #fff 11px, transparent 11px")+", transparent)",l={"min-width":a.width+"px","min-height":a.height+"px","max-height":a.height+"px",padding:"0 0 "+(u?"2px":"1px"),border:0,"border-radius":0,cursor:"default","text-indent":"-999999px"},c={attributes:!0,attributeFilter:["min","max","step","value"]},h=Array.prototype.forEach,p=document.createEvent("HTMLEvents");p.initEvent("change",!0,!1),"loading"==document.readyState?document.addEventListener("DOMContentLoaded",e,!0):e()}})();
//     keymaster.js
//     (c) 2011-2012 Thomas Fuchs
//     keymaster.js may be freely distributed under the MIT license.
(function(e){function t(e,t){var n=e.length;while(n--)if(e[n]===t)return n;return-1}function n(e,n){var r,i,o,u,a;r=e.keyCode,t(w,r)==-1&&w.push(r);if(r==93||r==224)r=91;if(r in m){m[r]=!0;for(o in y)y[o]==r&&(s[o]=!0);return}if(!s.filter.call(this,e))return;if(!(r in v))return;for(u=0;u<v[r].length;u++){i=v[r][u];if(i.scope==n||i.scope=="all"){a=i.mods.length>0;for(o in m)if(!m[o]&&t(i.mods,+o)>-1||m[o]&&t(i.mods,+o)==-1)a=!1;(i.mods.length==0&&!m[16]&&!m[18]&&!m[17]&&!m[91]||a)&&i.method(e,i)===!1&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}}function r(e){var n=e.keyCode,r,i=t(w,n);i>=0&&w.splice(i,1);if(n==93||n==224)n=91;if(n in m){m[n]=!1;for(r in y)y[r]==n&&(s[r]=!1)}}function i(){for(d in m)m[d]=!1;for(d in y)s[d]=!1}function s(e,t,n){var r,i,s,o;n===undefined&&(n=t,t="all"),e=e.replace(/\s/g,""),r=e.split(","),r[r.length-1]==""&&(r[r.length-2]+=",");for(s=0;s<r.length;s++){i=[],e=r[s].split("+");if(e.length>1){i=e.slice(0,e.length-1);for(o=0;o<i.length;o++)i[o]=y[i[o]];e=[e[e.length-1]]}e=e[0],e=b[e]||e.toUpperCase().charCodeAt(0),e in v||(v[e]=[]),v[e].push({shortcut:r[s],scope:t,method:n,key:r[s],mods:i})}}function o(e){if(typeof e=="string"){if(e.length!=1)return!1;e=e.toUpperCase().charCodeAt(0)}return t(w,e)!=-1}function u(){return w.slice(0)}function a(e){var t=(e.target||e.srcElement).tagName;return t!="INPUT"&&t!="SELECT"&&t!="TEXTAREA"}function f(e){g=e||"all"}function l(){return g||"all"}function c(e){var t,n,r;for(t in v){n=v[t];for(r=0;r<n.length;)n[r].scope===e?n.splice(r,1):r++}}function h(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,function(){n(window.event)})}function p(){var t=e.key;return e.key=E,t}var d,v={},m={16:!1,18:!1,17:!1,91:!1},g="all",y={"╬ô├º┬║":16,shift:16,"╬ô├«├æ":18,alt:18,option:18,"╬ô├«├ó":17,ctrl:17,control:17,"╬ô├«├┐":91,command:91},b={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},w=[];for(d=1;d<20;d++)y["f"+d]=111+d;for(d in y)s[d]=!1;h(document,"keydown",function(e){n(e,g)}),h(document,"keyup",r),h(window,"focus",i);var E=e.key;e.key=s,e.key.setScope=f,e.key.getScope=l,e.key.deleteScope=c,e.key.filter=a,e.key.isPressed=o,e.key.getPressedKeyCodes=u,e.key.noConflict=p,typeof module!="undefined"&&(module.exports=key)})(this);
var imgurUpload=function(e,t,n){var r=new XMLHttpRequest;r.open("POST","https://api.imgur.com/2/upload.json?key=1b3ed3ea4516d7c4ca0c8b7b4bcdbbf2",!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){r.readyState===4&&(r.status===200?typeof t=="function"&&t(r.responseText):typeof n=="function"&&n(r.responseText))},r.send(e)};
var $=function(e,t,n){return n=n||document,t?n.querySelectorAll(e):n.querySelector(e)};$.extend=function(e,t){for(var n in t)e[n]=t[n];return e},$.getNeighbor=function(e,t,n,r){var i=t.indexOf(e);if(i<0)throw new Error("Element not in array.");var s=t[i-1],o=t[i+1];if(r)n&&(s=o);else if(s===undefined||n&&o!==undefined)s=o;return s||null},$.make=function(e,t,n,r){r=r||window;var i=r.document.createElement(e);return typeof t=="object"&&$.extend(i,t),n&&n.appendChild&&n.appendChild(i),i},$.removeElement=function(e){e.parentNode.removeChild(e)},$.swapElementSiblings=function(e,t){var n=e.parentNode,r=t.nextElementSibling;r===e?(n.removeChild(e),n.insertBefore(e,t)):(n.removeChild(t),n.insertBefore(t,e),n.removeChild(e),r?n.insertBefore(e,r):n.appendChild(e))},function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r=Date.now(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();
function pluginLoaded(){var e=$("#wtPlugin");app.pen.penAPI=e&&e.penAPI}var app={overlay:null,activeFrame:null,frames:[],canvasCount:0,viewWidth:400,viewHeight:300,buffer:$.make("canvas").getContext("2d"),tools:{},canvasContainer:$("#canvas-container"),toolContainer:$("#tool-box .container"),layerContainer:$("#layer-box .container"),thumbContainer:$("#thumb-box .container"),copyLayerRef:null,actions:{done:[],undone:[],current:null}};app.overlay=$.make("canvas",{width:app.viewWidth,height:app.viewHeight,className:"overlay"},app.canvasContainer).getContext("2d"),app.exportGIF=function(){var e=$("#gif-fps-input"),t=+e.value;if(!t||t<=0)t=12;e.value=t;var n=new GIFEncoder;return n.start(),n.setRepeat(0),n.setFrameRate(t),app.buffer.canvas.width=app.viewWidth,app.buffer.canvas.height=app.viewHeight,app.buffer.fillStyle="#fff",app.frames.forEach(function(e){app.buffer.fillRect(0,0,app.viewWidth,app.viewHeight);var t=e.layers.length;while(t-->0)app.buffer.drawImage(e.layers[t].canvas,0,0);n.addFrame(app.buffer)}),n.finish(),n.stream().getData()},app.getActiveLayer=function(){return app.activeFrame&&app.activeFrame.activeLayer},app.deselectTools=function(){var e=$(".active",!0,app.toolContainer);for(var t=0;t<e.length;t++)e[t].classList.remove("active")},app.selectToolButton=function(){app.deselectTools(),this.classList.add("active"),app.pen.activeTool=this.getAttribute("data-tool-name")},app.selectTool=function(e){if(!(e in app.tools))throw new Error("Tool does not exist.");app.deselectTools(),app.tools[e].button.classList.add("active"),app.pen.activeTool=e},app.pushNewAction=function(e){if(!e||!e.type)throw new Error("Action type required.");var t=app.actions;return t.done.push(e),t.done.length>15&&t.done.shift(),t.undone.length=0,e},app.Layer=function(e){var t=this;app.canvasCount+=1;if(!e)throw new Error("Frame required to create layer.");this.frame=e,this.canvas=$.make("canvas",{width:app.viewWidth,height:app.viewHeight,className:"layer-"+app.canvasCount}),this.ctx=this.canvas.getContext("2d"),this.thumb=$.make("div",{className:"thumb",onclick:function(){t.select()}}),this.insert(e.activeLayer).select()},app.Layer.prototype.insert=function(e){return e?this.frame.layers.splice(this.frame.layers.indexOf(e),0,this):this.frame.layers.push(this),this.frame.canvasGroup.appendChild(this.canvas),e?this.frame.layerThumbGroup.insertBefore(this.thumb,e.thumb):this.frame.layerThumbGroup.appendChild(this.thumb),this.frame.updateZIndices(),this},app.Layer.prototype.remove=function(){var e=this.frame.layers;return this.frame.activeLayer=$.getNeighbor(this,e,!0,!1),e.splice(e.indexOf(this),1),this.thumb.classList.remove("active"),$.removeElement(this.canvas),$.removeElement(this.thumb),this.frame.activeLayer&&this.frame.activeLayer.select(),this.updateFrameThumb(),this},app.Layer.prototype.updateThumb=function(){var e=this.thumb.offsetWidth-2,t=this.thumb.offsetHeight-2;return app.buffer.canvas.width=e,app.buffer.canvas.height=t,app.buffer.clearRect(0,0,e,t),app.buffer.drawImage(this.canvas,0,0,e,t),this.thumb.style.backgroundImage="url('"+app.buffer.canvas.toDataURL()+"')",this},app.Layer.prototype.updateFrameThumb=function(){return this.updateThumb(),this.frame.updateThumb(),this},app.Layer.prototype.paste=function(e){return this.ctx.drawImage(e,0,0),this},app.Layer.prototype.clear=function(){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this},app.Layer.prototype.merge=function(e){if(!e)throw new Error("Destination layer required.");return e.paste(this.canvas),this.remove(),e.updateFrameThumb(),this},app.Layer.prototype.select=function(){this.frame.activeLayer=this;var e=$(".active",!0,this.thumb.parentNode),t=e.length;while(t-->0)e[t].classList.remove("active");return this.thumb.classList.add("active"),this},app.Layer.prototype.move=function(e){var t=$.getNeighbor(this,this.frame.layers,e,!0);return t&&app.swapFrameOrLayer(this.frame.layers,this,t,!0),!!t},app.Layer.prototype.loadURL=function(e,t){var n=this,r=new Image;return r.onload=function(){n.paste(this),t&&t.call&&t.call(n)},r.src=e,this},app.Layer.prototype.offset=function(e,t){return app.buffer.canvas.width=this.canvas.width,app.buffer.canvas.height=this.canvas.height,app.buffer.drawImage(this.canvas,e,t),this.clear().paste(app.buffer.canvas).updateFrameThumb(),this},app.Layer.prototype.pushNewAction=function(e){return e.target||(e.target=this),e.type==="edit"&&!e.data&&(e.data=this.canvas.toDataURL()),app.pushNewAction(e),this},app.Frame=function(e){var t=this;this.layers=[],this.layerThumbGroup=$.make("div",{className:"group"}),this.canvasGroup=$.make("div",{className:"group"}),this.thumb=$.make("div",{id:"frame-thumb-"+app.canvasCount,className:"thumb",onmousedown:function(){t.select()}}),this.insert(app.activeFrame).select(),e||new app.Layer(this)},app.Frame.prototype.insert=function(e){app.layerContainer.appendChild(this.layerThumbGroup),app.canvasContainer.appendChild(this.canvasGroup);var t=e?app.frames.indexOf(e):-1;return t>-1?t<app.frames.length-1?(app.frames.splice(t+1,0,this),app.thumbContainer.insertBefore(this.thumb,e.thumb.nextElementSibling)):(app.frames.push(this),app.thumbContainer.appendChild(this.thumb)):(app.frames.push(this),app.thumbContainer.appendChild(this.thumb)),this},app.Frame.prototype.remove=function(){return app.activeFrame=$.getNeighbor(this,app.frames,!0,!1),app.frames.splice(app.frames.indexOf(this),1),this.thumb.classList.remove("active"),$.removeElement(this.canvasGroup),$.removeElement(this.layerThumbGroup),$.removeElement(this.thumb),app.activeFrame&&app.activeFrame.select(),this},app.Frame.prototype.duplicate=function(){var e=this.layers.indexOf(this.activeLayer),t=new app.Frame(!0),n=this.layers.length;while(n-->0){var r=new app.Layer(t);r.paste(this.layers[n].canvas).updateThumb()}return t.layers[e].select(),t.updateThumb(),this},app.Frame.prototype.select=function(){app.activeFrame=this;var e,t,n,r;e=$(".active.group",!0,app.canvasContainer),r=e.length;while(r-->0)e[r].classList.remove("active");this.canvasGroup.classList.add("active"),t=$(".active.group",!0,app.layerContainer),r=t.length;while(r-->0)t[r].classList.remove("active");this.layerThumbGroup.classList.add("active"),n=$(".active",!0,app.thumbContainer),r=n.length;while(r-->0)n[r].classList.remove("active");return this.thumb.classList.add("active"),this},app.Frame.prototype.move=function(e){var t=$.getNeighbor(this,app.frames,e,!0);return t&&app.swapFrameOrLayer(app.frames,this,t,!1),!!t},app.Frame.prototype.updateThumb=function(){var e=this.thumb.offsetWidth-2,t=this.thumb.offsetHeight-2;app.buffer.width=e,app.buffer.height=t,app.buffer.clearRect(0,0,e,t);var n=this.layers.length;while(n-->0)app.buffer.drawImage(this.layers[n].canvas,0,0,e,t);return this.thumb.style.backgroundImage="url('"+app.buffer.canvas.toDataURL()+"')",this},app.Frame.prototype.updateZIndices=function(){for(var e=0,t=this.layers.length;e<t;e++)this.layers[e].canvas.style.zIndex=t-e;return this},app.Frame.prototype.pushNewAction=function(e){return e.target||(e.target=this),app.pushNewAction(e),this},app.swapFrameOrLayer=function(e,t,n,r){if(!t||!n)return;i1=e.indexOf(t),i2=e.indexOf(n);if(i1<0||i2<0)return;e[i1]=n,e[i2]=t,$.swapElementSiblings(t.thumb,n.thumb),r&&($.swapElementSiblings(t.canvas,n.canvas),t.frame.updateZIndices())},app.createTool=function(e,t,n,r){var i={};return i.button=$.make("button",{className:"tool",innerHTML:t},app.toolContainer),i.button.setAttribute("data-tool-name",e),n&&(i.activate=n,i.button.addEventListener("click",n,!1)),r&&key(r,function(){n.call(i.button)}),app.tools[e]=i,i},app.createPenTool=function(e,t,n,r,i){if(typeof n!="function")throw new Error("ondraw required.");if(typeof r!="function")throw new Error("onoverlay required");var s=app.createTool(e,t,app.selectToolButton,i);return s.draw=n,s.drawOverlay=r,s},app.pen={isDown:!1,isEraser:!1,pos:Int32Array&&new Int32Array(6)||new Array(6),pressure:1,diameter:6,eraserDiameter:30,activeTool:"",color:"#333333"},app.pen.getPos=function(e){var t=this;t.pos[5]=t.pos[3],t.pos[4]=t.pos[2],t.pos[3]=t.pos[1],t.pos[2]=t.pos[0],t.penAPI&&(t.pressure=t.penAPI.pressure||1,t.isEraser=t.penAPI.isEraser||!1);if(typeof e.pageX=="number"){var n=app.canvasContainer.parentNode;t.pos[0]=e.pageX-n.offsetLeft,t.pos[1]=e.pageY-n.offsetTop}else typeof e.offsetX=="number"?(t.pos[0]=e.offsetX,t.pos[1]=e.offsetY):typeof e.layerX=="number"&&(t.pos[0]=e.layerX,t.pos[1]=e.layerY)},function(){function n(n){if(e.isDown){e.isDown=!1;var r=app.getActiveLayer();r&&(app.tools[e.activeTool].draw(r.ctx,3),r.updateFrameThumb(),t.data=r.canvas.toDataURL(),t=null)}}function r(n){n.touches&&(n.preventDefault(),n=n.touches[0]),e.isDown=!0,e.getPos(n),e.getPos(n);var r=app.getActiveLayer();r&&(t=app.pushNewAction({type:"edit",target:r,dataPre:r.canvas.toDataURL()}),app.tools[e.activeTool].draw(r.ctx,1))}function s(){var t=app.tools[e.activeTool];if(e.isDown){var n=app.getActiveLayer();n&&t.draw(n.ctx,2)}t.drawOverlay&&t.drawOverlay(app.overlay),i=!1}function o(t){t.touches&&(e.isDown&&t.preventDefault(),t=t.touches[0]),i||(e.getPos(t),requestAnimationFrame(s),i=!0)}var e=app.pen;new app.Frame(!0);var t=null,i=!1;app.overlay.canvas.addEventListener("mousedown",r,!1),app.overlay.canvas.addEventListener("touchstart",r,!1),window.addEventListener("mouseup",n,!1),window.addEventListener("touchend",n,!1),window.addEventListener("mousemove",o,!1),window.addEventListener("touchmove",o,!1);var u=$("#tool-diameter-slider");$("#tool-diameter-value").innerHTML=u.value=e.diameter,u.onchange=function(){e.diameter=+this.value,$("#tool-diameter-value").innerHTML=e.diameter},key("[",function(){var e=+u.value;u.value=e>10?Math.round(e*.9):e-1,u.onchange()}),key("]",function(){var e=+u.value;u.value=e>10?Math.round(e*1.1):e+1,u.onchange()});var a=$("#pen-color-picker");a.type==="text"&&(a.className="color",jscolor&&jscolor.bind()),a.value=e.color,a.onchange=function(){e.color=this.value},$("#new-frame-button").onclick=function(){var e=app.activeFrame;(new app.Frame(!1)).pushNewAction({type:"newframe",nextTo:e})},key("ctrl+shift+f",$("#new-frame-button").onclick),$("#duplicate-frame-button").onclick=function(){var e=app.activeFrame;e.duplicate().pushNewAction({type:"newframe",nextTo:e})},$("#delete-frame-button").onclick=function(){app.activeFrame.pushNewAction({type:"deleteframe",nextTo:$.getNeighbor(app.activeFrame,app.frames,!1,!1)}).remove()},$("#move-frame-left-button").onclick=function(){app.activeFrame&&app.activeFrame.move(!1)},$("#move-frame-right-button").onclick=function(){app.activeFrame&&app.activeFrame.move(!0)};var f=$("#new-layer-button");(f.onclick=function(){if(app.activeFrame){var e=app.getActiveLayer();(new app.Layer(app.activeFrame)).pushNewAction({type:"newlayer",nextTo:e})}})(),key("ctrl+alt+shift+n",function(){f.onclick()}),$("#merge-down-layer-button").onclick=function(){var e=app.getActiveLayer();if(!e)return;var t=$.getNeighbor(e,e.frame.layers,!0,!0);if(!t)return;e.pushNewAction({type:"mergedlayer",target2:t,data:t.canvas.toDataURL()}).merge(t)},$("#delete-layer-button").onclick=function(){var e=app.getActiveLayer();if(e){var t=e.frame.layers,n=$.getNeighbor(e,t,!0,!1);e.remove().pushNewAction({type:"deletelayer",nextTo:n})}},$("#copy-layer-button").onclick=function(){var e=app.getActiveLayer();e&&(app.copyLayerRef=e)},$("#paste-layer-button").onclick=function(){if(!app.copyLayerRef||!app.activeFrame)return;var e=app.getActiveLayer();(new app.Layer(app.activeFrame)).paste(app.copyLayerRef.canvas).updateFrameThumb().pushNewAction({type:"pastelayer",nextTo:e})},$("#move-layer-up-button").onclick=function(){var e=app.getActiveLayer();e&&e.move(!1)&&e.pushNewAction({type:"movelayerup"})},key("ctrl+shift+up",$("#move-layer-up-button").onclick),$("#move-layer-down-button").onclick=function(){var e=app.getActiveLayer();e&&e.move(!0)&&e.pushNewAction({type:"movelayerdown"})},key("ctrl+shift+down",$("#move-layer-down-button").onclick),$("#export-gif-button").addEventListener("click",function(){var e=open("","Gif"+Date.now(),"width="+(app.viewWidth+20)+",height="+(app.viewHeight+60)),t=e.document.createElement("img"),n=btoa(app.exportGIF());t.src="data:image/gif;base64,"+n,e.document.body.appendChild(t),e.document.title="New Gif | SimpleAnimateTool",$.make("button",{innerHTML:"Upload to imgur",id:"upload-to-imgur-button",onclick:function(){var t=window.open();imgurUpload(n,function(n){var r=JSON.parse(n);t.location.href=r.upload.links.imgur_page,$.removeElement($("#upload-to-imgur-button",!1,e.document)),$.make("a",{href:r.upload.links.imgur_page,innerHTML:"Imgur link",target:"_blank"},e.document.body,e),$.make("a",{href:r.upload.links.delete_page,innerHTML:"Delete link",target:"_blank"},e.document.body,e)},function(){$.make("p",{innerHTML:"Upload failed :("},e.document.body,e),console.log(response)})}},e.document.body,e)},!1)}();
(function(){function t(t){t.clearRect(0,0,app.viewWidth,app.viewHeight),t.beginPath(),t.arc(e.pos[0],e.pos[1],e.diameter/2,0,2*Math.PI,!1),t.stroke()}function n(t){var n=e.diameter/2;t.clearRect(0,0,t.canvas.width,t.canvas.height),t.strokeRect(e.pos[0]-n,e.pos[1]-n,2*n,2*n)}function r(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),t.beginPath(),t.moveTo(e.pos[0]-2.5,e.pos[1]+.5),t.lineTo(e.pos[0]+4.5,e.pos[1]+.5),t.moveTo(e.pos[0]+.5,e.pos[1]-3.5),t.lineTo(e.pos[0]+.5,e.pos[1]+3.5),t.stroke()}function i(e,t,n){e[0]>e[2]?e[1]>e[3]?(n[0]=e[0]-t,n[1]=e[1]+t,n[2]=e[0]+t,n[3]=e[1]+t,n[4]=e[0]+t,n[5]=e[1]-t,n[6]=e[2]+t,n[7]=e[3]-t,n[8]=e[2]-t,n[9]=e[3]-t,n[10]=e[2]-t,n[11]=e[3]+t):(n[0]=e[0]+t,n[1]=e[1]+t,n[2]=e[0]+t,n[3]=e[1]-t,n[4]=e[0]-t,n[5]=e[1]-t,n[6]=e[2]-t,n[7]=e[3]-t,n[8]=e[2]-t,n[9]=e[3]+t,n[10]=e[2]+t,n[11]=e[3]+t):e[1]>e[3]?(n[0]=e[0]-t,n[1]=e[1]-t,n[2]=e[0]-t,n[3]=e[1]+t,n[4]=e[0]+t,n[5]=e[1]+t,n[6]=e[2]+t,n[7]=e[3]+t,n[8]=e[2]+t,n[9]=e[3]-t,n[10]=e[2]-t,n[11]=e[3]-t):(n[0]=e[0]+t,n[1]=e[1]-t,n[2]=e[0]-t,n[3]=e[1]-t,n[4]=e[0]-t,n[5]=e[1]+t,n[6]=e[2]-t,n[7]=e[3]+t,n[8]=e[2]+t,n[9]=e[3]+t,n[10]=e[2]+t,n[11]=e[3]-t)}var e=app.pen;app.createPenTool("round-brush-a","Round Brush *tablet",function(e,t){var n=app.pen,r=0;n.isEraser?(e.globalCompositeOperation="destination-out",r=n.pressure*n.eraserDiameter):r=n.pressure*n.diameter,t===1?(e.fillStyle=n.color,e.beginPath(),e.arc(n.pos[0],n.pos[1],r/2,0,2*Math.PI,!1),e.fill()):t===2?(e.strokeStyle=n.color,e.lineWidth=r,e.lineCap=e.lineJoin="round",e.beginPath(),e.moveTo((n.pos[2]+n.pos[4])/2,(n.pos[3]+n.pos[5])/2),e.quadraticCurveTo(n.pos[2],n.pos[3],(n.pos[2]+n.pos[0])/2,(n.pos[3]+n.pos[1])/2),e.stroke()):t===3,n.isEraser&&(e.globalCompositeOperation="source-over")},t),app.createPenTool("round-brush","Round Brush",function(e,t){var n=app.pen;t===1?(e.fillStyle=n.color,e.beginPath(),e.arc(n.pos[0],n.pos[1],n.diameter/2,0,2*Math.PI,!1),e.fill()):t===2?(e.strokeStyle=n.color,e.lineWidth=n.diameter,e.lineCap=e.lineJoin="round",e.beginPath(),e.moveTo((n.pos[2]+n.pos[4])/2,(n.pos[3]+n.pos[5])/2),e.quadraticCurveTo(n.pos[2],n.pos[3],(n.pos[2]+n.pos[0])/2,(n.pos[3]+n.pos[1])/2),e.stroke()):t===3},t),key("b",function(){app.selectTool(e.penAPI?"round-brush":"round-brush-a")});var s=Int32Array&&new Int32Array(12)||new Array(12);app.createPenTool("sqpencil","Square Brush",function(e,t){var n=app.pen,r=n.diameter/2;e.fillStyle=n.color;if(t===1)e.fillRect(n.pos[0]-r,n.pos[1]-r,2*r,2*r);else if(t===2){var o=s;i(n.pos,r,o),e.lineCap=e.lineJoin="round",e.beginPath(),e.moveTo(o[0],o[1]);for(var u=2;u<o.length;u+=2)e.lineTo(o[u],o[u+1]);e.closePath(),e.fill()}else t===3},n),app.createPenTool("eraser","Eraser",function(e,t){var n=app.pen;e.globalCompositeOperation="destination-out",t===1?(e.beginPath(),e.arc(n.pos[0],n.pos[1],n.diameter/2,0,2*Math.PI,!1),e.fill()):t===2?(e.lineWidth=n.diameter,e.lineCap=e.lineJoin="round",e.beginPath(),e.moveTo((n.pos[2]+n.pos[4])/2,(n.pos[3]+n.pos[5])/2),e.quadraticCurveTo(n.pos[2],n.pos[3],(n.pos[2]+n.pos[0])/2,(n.pos[3]+n.pos[1])/2),e.stroke()):t===3,e.globalCompositeOperation="source-over"},t,"e");var o=["#","00","00","00"];app.createPenTool("eyedropper","Eyedropper",function(e,t){if(t===3)return;var n=4*(e.canvas.width*app.pen.pos[1]+app.pen.pos[0]),r=e.getImageData(0,0,e.canvas.width,e.canvas.height).data;o[1]=r[n].toString(16),o[2]=r[n+1].toString(16),o[3]=r[n+2].toString(16);for(n=1;n<4;n++)while(o[n].length<2)o[n]="0"+o[n];var i=$("#pen-color-picker");i.value=o.join(""),i.onchange()},r),app.createTool("offset-layer","Offset Layer",function(){var e=app.getActiveLayer();if(!e)return;var t=+prompt("Enter x-offset amount (px)","")||0,n=-prompt("Enter y-offset amount (px)","")||0;if(t!==0||n!==0)var r=e.pushNewAction({type:"edit",dataPre:e.canvas.toDataURL()});e.offset(t,n),r.data=e.canvas.toDataURL()}),app.createTool("undo","Undo",function(){var e=app.actions.done.pop();if(!e)return;switch(e.type){case"edit":e.target.clear().loadURL(e.dataPre,e.target.updateFrameThumb);break;case"newlayer":e.target.remove();break;case"deletelayer":e.target.insert(e.nextTo).select().updateFrameThumb();break;case"mergedlayer":e.target.insert(e.target2).select().updateThumb(),e.target2.clear().loadURL(e.data,e.target2.updateFrameThumb);break;case"pastelayer":e.target.remove();break;case"movelayerup":e.target.move(!0);break;case"movelayerdown":e.target.move(!1);break;case"newframe":e.target.remove();break;case"deleteframe":e.target.insert(e.nextTo).select();break;default:throw new Error("Unknown action type undone.")}app.actions.undone.push(e)},"ctrl+z, command+z"),app.createTool("redo","Redo",function(){var e=app.actions.undone.pop();if(!e)return;switch(e.type){case"edit":e.target.clear().loadURL(e.data,e.target.updateFrameThumb);break;case"newlayer":e.target.insert(e.nextTo).updateFrameThumb();break;case"deletelayer":e.target.remove();break;case"mergedlayer":e.target.merge(e.target2);break;case"pastelayer":e.target.insert(e.nextTo).updateFrameThumb();break;case"movelayerup":e.target.move(!1);break;case"movelayerdown":e.target.move(!0);break;case"newframe":e.target.insert(e.nextTo).select().updateThumb();break;case"deleteframe":e.target.remove();break;default:throw new Error("Unknown action type redone.")}app.actions.done.push(e)},"ctrl+y, command+y"),app.selectTool(e.penAPI?"round-brush":"round-brush-a")})();
